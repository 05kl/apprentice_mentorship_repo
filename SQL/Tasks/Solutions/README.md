# 1. Insurance System
## Queries:

a) 
```SQL
SELECT *
FROM POLICY p
JOIN INSURANCE_TYPE i
ON i.TYPEID = p.INSURANCE_TYPEID
WHERE i.NAME = 'VEHICLE INSURANCE' AND p.ISSUE_DATE = '2024-01-15'
ORDER BY 
  CASE 
    WHEN p.PREMIUM_CLASS = 'PREMIUM' THEN 0
    ELSE 1
  END,
  p.PREMIUM_CLASS;
```

b)  
```SQL
USE basic_recap_ivana;

SELECT *
FROM POLICY p
WHERE p.ISSUE_DATE <= DATEADD(MONTH, -3, GETDATE());

BEGIN TRANSACTION;

DELETE
FROM POLICY
WHERE POLICY.ISSUE_DATE <= DATEADD(MONTH, -3, GETDATE());

SELECT @@ROWCOUNT AS RowsDeleted;
```

c) 
```SQL
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS POLICY_ISSUES.ISSUED_POLICIES
GO

DROP SCHEMA IF EXISTS POLICY_ISSUES;
GO

CREATE SCHEMA POLICY_ISSUES;
GO

CREATE VIEW POLICY_ISSUES.ISSUED_POLICIES
AS
SELECT YEAR(p.ISSUE_DATE) AS ISSUE_YEAR, MONTH(p.ISSUE_DATE) AS ISSUE_MONTH, COUNT(YEAR(p.ISSUE_DATE)) AS TOTAL_COUNT, SUM(TOTAL_AMOUNT) AS ISSUES_VALUE
FROM POLICY p
JOIN INSURANCE_TYPE i
ON p.INSURANCE_TYPEID = i.TYPEID
WHERE i.NAME = 'PROPERTY INSURANCE' OR i.NAME = 'LIFE INSURANCE' AND p.ISSUE_DATE >= '2000-01-01'
GROUP BY YEAR(p.ISSUE_DATE), MONTH(p.ISSUE_DATE)
;
GO

SELECT * FROM POLICY_ISSUES.ISSUED_POLICIES;
GO

SELECT * FROM POLICY;
GO

SELECT * FROM INSURANCE_TYPE;
```

d) 
(I wasnâ€™t able to find a table with the contens of approval for: NUMBER_OF_APPROVED)
```SQL
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS POLICY_ISSUES.DISPUTECLAIMS
GO

DROP SCHEMA IF EXISTS POLICY_ISSUES;
GO

CREATE SCHEMA POLICY_ISSUES;
GO

CREATE VIEW POLICY_ISSUES.DISPUTECLAIMS AS
SELECT
pbp.POLICYID AS POLICY_NUMBER,
p.ISSUE_DATE AS POLICY_DATE,
p.TOTAL_AMOUNT AS TOTAL_LIABILITY,
SUM(pbp.Amount) AS TOTAL_PAID
FROM PAYMENT_BY_POLICY pbp
JOIN POLICY p
ON pbp.POLICYID = p.POLICYID
GROUP BY pbp.POLICYID, p.ISSUE_DATE, p.TOTAL_AMOUNT
;
GO

SELECT * FROM POLICY_ISSUES.DISPUTECLAIMS;
GO
```

# 2. Airport System

## Queries

a) 
```SQL
USE basic_recap_ivana;
GO

SELECT res.STATUS
FROM RESERVATION res
JOIN FLIGHT f
ON f.ROUTEID = res.SEQ_NUM
JOIN ROUTE r
ON f.ROUTEID = r.ROUTEID
JOIN AIRPORT air
ON r.DESTINATION_AERO = air.AEROID
WHERE COUNTRY = 'SWITZERLAND'
AND CITY = 'Zurich'
AND YEAR(f.DATE_TIME) = '2003'
AND MONTH(f.DATE_TIME) = '11'
AND DAY(f.DATE_TIME) = '15'
;

USE basic_recap_ivana;
GO

UPDATE RESERVATION
SET STATUS = 'Postponed'
FROM RESERVATION res
JOIN FLIGHT f
ON f.ROUTEID = res.SEQ_NUM
JOIN ROUTE r
ON f.ROUTEID = r.ROUTEID
JOIN AIRPORT air
ON r.DESTINATION_AERO = air.AEROID
WHERE COUNTRY = 'SWITZERLAND'
AND CITY = 'Zurich'
AND YEAR(f.DATE_TIME) = '2003'
AND MONTH(f.DATE_TIME) = '11'
AND DAY(f.DATE_TIME) = '15'
;
```
b) 

```SQL
SELECT f.DATE_TIME, r.ROUTEID, dep_air.NAME, des_air.NAME
FROM RESERVATION res
JOIN FLIGHT f
ON f.ROUTEID = res.SEQ_NUM
JOIN ROUTE r
ON f.ROUTEID = r.ROUTEID
JOIN AIRPORT des_air
ON r.DESTINATION_AERO = des_air.AEROID
JOIN AIRPORT dep_air
ON r.DEPARTURE_AERO = dep_air.AEROID
WHERE dep_air.COUNTRY = 'GREAT BRITAIN'
AND des_air.COUNTRY = 'GERMANY'
AND MONTH(f.DATE_TIME) >= '5' OR MONTH(f.DATE_TIME) <= '7'
ORDER BY f.DATE_TIME
;
```

c)
```SQL
Im not sure how to get the passengers which actually flew
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS AIRPORT.REALIZATION
GO

DROP SCHEMA IF EXISTS AIRPORT;
GO

CREATE SCHEMA AIRPORT;
GO

CREATE VIEW AIRPORT.REALIZATION
AS
SELECT r.ROUTEID AS RouteNumber,
COUNT(f.ROUTEID) AS NumberOfCompletedFlights,
COUNT(res.SEQ_NUM) AS TotalNumberOfPassengers,
SUM(airc.NUM_SEATS) AS TotalCapacities,
CAST(COUNT(res.SEQ_NUM) AS DECIMAL) / SUM(airc.NUM_SEATS) AS AverageFlightOccupancy
FROM RESERVATION res
JOIN FLIGHT f
ON res.ROUTEID = f.ROUTEID AND res.DATE_TIME = f.DATE_TIME
JOIN AIRCRAFT airc
ON f.PLANEID = airc.PLANEID
JOIN ROUTE r
ON f.ROUTEID = r.ROUTEID
WHERE res.STATUS = 'OK' OR res.STATUS = 'Postponed'
GROUP BY r.ROUTEID
;

GO

SELECT * FROM AIRPORT.REALIZATION;
```

# 3. Project Management System
## Queries
    a)
USE basic_recap_ivana;

SELECT COUNT(e.WORKER_CODE) AS PROJECT_COUNT, w.WORKER_NAME, w.WORKER_CODE, w.HIRE_DATE
FROM ENGAGEMENT e
JOIN WORKER w
ON w.WORKER_CODE = e.WORKER_CODE
JOIN PROJECT p
ON e.PROJ_CODE = p.PROJ_CODE
JOIN COMPANY c
ON w.COMPANY_CODE = c.COMPANY_CODE
WHERE YEAR(w.HIRE_DATE) >= YEAR(GETDATE())-10

GROUP BY w.WORKER_CODE, w.WORKER_NAME, w.HIRE_DATE
HAVING COUNT(e.WORKER_CODE) >= 2
ORDER BY w.HIRE_DATE
;

    b)

USE basic_recap_ivana;

SELECT COUNT(e.WORKER_CODE) AS PROJECT_COUNT, w.WORKER_NAME, w.WORKER_CODE, w.HIRE_DATE, w.SALARY
FROM ENGAGEMENT e
JOIN WORKER w
ON w.WORKER_CODE = e.WORKER_CODE
JOIN PROJECT p
ON e.PROJ_CODE = p.PROJ_CODE
JOIN COMPANY c
ON w.COMPANY_CODE = c.COMPANY_CODE
WHERE w.SALARY > '30000'

GROUP BY w.WORKER_CODE, w.WORKER_NAME, w.HIRE_DATE, w.SALARY
HAVING COUNT(e.WORKER_CODE) >= 1
ORDER BY w.HIRE_DATE
;
    c)
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS WORK.MANAGER
GO

DROP SCHEMA IF EXISTS WORK;
GO

CREATE SCHEMA WORK;
GO

CREATE VIEW WORK.MANAGER
AS
SELECT
c.NAME AS CompanyName,
w.WORKER_NAME AS WorkerName,
w.WORKER_CODE AS WorkerCode,
w.HIRE_DATE AS HireDate
FROM ENGAGEMENT e
JOIN WORKER w
ON w.WORKER_CODE = e.WORKER_CODE
JOIN PROJECT p
ON e.PROJ_CODE = p.PROJ_CODE
JOIN COMPANY c
ON w.COMPANY_CODE = c.COMPANY_CODE
WHERE w.IS_MANAGER = 'TRUE'
GROUP BY c.NAME, w.WORKER_NAME, w.WORKER_CODE, w.HIRE_DATE
HAVING COUNT(e.WORKER_CODE) = 0
;

GO

SELECT * FROM WORK.MANAGER;



    d)

USE basic_recap_ivana;

SELECT
	CASE
		WHEN DATEDIFF(YEAR, w.BIRTH_DATE, GETDATE()) < 20 THEN 'under 20'
        WHEN DATEDIFF(YEAR, w.BIRTH_DATE, GETDATE()) BETWEEN 20 AND 45 THEN 'between 20 and 45'
        ELSE 'over 45'
	END AS AGE_GROUP,
	COUNT(w.WORKER_CODE) AS WORKER_COUNT,
	c.CITY,
	w.BIRTH_DATE
FROM WORKER w
JOIN COMPANY c
ON w.WORKER_CODE = c.COMPANY_CODE
GROUP BY
	CASE
		WHEN DATEDIFF(YEAR, w.BIRTH_DATE, GETDATE()) < 20 THEN 'under 20'
        WHEN DATEDIFF(YEAR, w.BIRTH_DATE, GETDATE()) BETWEEN 20 AND 45 THEN 'between 20 and 45'
        ELSE 'over 45'
	END,
c.CITY,
w.BIRTH_DATE
;

# 4. University System
## Queries
a)

USE basic_recap_ivana;

SELECT p.NAME, p.Surname, p.HireDate, f.FacultyName
FROM PROFESSOR p
JOIN FACULTY f
ON p.HomeFaculty = f.FacultyCode
JOIN UNIVERSITY u
ON f.UniversityCode = u.UniversityCode
WHERE u.UniversityName = 'University of Belgrade'
AND DATEDIFF(YEAR, p.HireDate, GETDATE()) >= 10
ORDER BY p.HireDate DESC, p.Surname ASC
;
b)

USE basic_recap_ivana;

SELECT f.FacultyName, u.UniversityCode, COUNT(ep.SSN) AS PROFESSOR_COUNT
FROM ENGAGEMENT_PROF ep
JOIN PROFESSOR p
ON ep.SSN = p.SSN
JOIN FACULTY f
ON ep.FacultyCode = f.FacultyCode
JOIN UNIVERSITY u
ON f.UniversityCode = u.UniversityCode
GROUP BY f.FacultyName, u.UniversityCode
HAVING COUNT(ep.SSN) BETWEEN 50 AND 100
ORDER BY u.UniversityCode DESC
c)

USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS UNIVERSITIES.FEES;
GO

DROP SCHEMA IF EXISTS UNIVERSITIES;
GO

CREATE SCHEMA UNIVERSITIES;
GO

CREATE VIEW UNIVERSITIES.FEES
AS
SELECT pro.Surname, pro.Name, COUNT(DISTINCT f.FacultyCode) AS NUMBER_OF_FACULTIES,
MONTH(pay.PaymentDate) AS MONTH_PAYED, SUM(pay.Amount) AS TOTAL_MONTHLY_PAYMENT
FROM PAYMENT pay
JOIN ENGAGEMENT_PROF ep
ON pay.FacultyCode = ep.FacultyCode AND pay.SSN = ep.SSN
JOIN PROFESSOR pro
ON ep.SSN = pro.SSN
JOIN FACULTY f
ON ep.FacultyCode = f.FacultyCode
JOIN UNIVERSITY u
ON f.UniversityCode = u.UniversityCode
WHERE pay.PaymentDate >= DATEADD(YEAR, -1, GETDATE())
AND f.FacultyCode != pro.HomeFaculty
GROUP BY pro.Surname, pro.Name, MONTH(pay.PaymentDate)
;

GO
SELECT * FROM UNIVERSITIES.FEES;

# 5. Student Admission System
## Queries
a)
USE basic_recap_ivana;

SELECT c.Surname, c.Name, s.SchoolName, c.OverallSuccess, c.SSN
FROM CANDIDATE c
JOIN SCHOOL s
ON c.CompletedSchool = s.SchoolCode
WHERE c.ApplicationDate = '2003-6-25'
AND s.SchoolType = 'Technical'
ORDER BY c.Surname ASC;


b)

USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS SCHOOL.GeneralSuccess ;
GO

DROP SCHEMA IF EXISTS SCHOOL;
GO

CREATE SCHEMA SCHOOL;
GO

CREATE VIEW SCHOOL.GeneralSuccess
AS
SELECT can.OverallSuccess, COUNT(cer.SSN) AS NUMBER_OF_CANDIDATES, cer.Average AS AVERAGE_SUCCESS
FROM GRADE gra
JOIN CERTIFICATE cer
ON gra.SSN = cer.SSN AND gra.Year = cer.Year
JOIN CANDIDATE can
ON cer.SSN = can.SSN
JOIN SCHOOL sch
ON cer.SchoolCode = sch.SchoolCode
JOIN PLACE pla
ON pla.PlaceCode = sch.PlaceCode
WHERE cer.Year = 4
GROUP BY can.OverallSuccess, cer.Average
;

GO
SELECT * FROM SCHOOL.GeneralSuccess;


c)

USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS SCHOOL1.SuccessByPlaces  ;
GO

DROP SCHEMA IF EXISTS SCHOOL1;
GO

CREATE SCHEMA SCHOOL1;
GO

CREATE VIEW SCHOOL1.SuccessByPlaces
AS
SELECT pla.PlaceName, can.OverallSuccess, COUNT(DISTINCT cer.SSN) AS NUMBER_OF_CANDIDATES
FROM CERTIFICATE cer
JOIN CANDIDATE can
ON cer.SSN = can.SSN
JOIN SCHOOL sch
ON cer.SchoolCode = sch.SchoolCode
JOIN PLACE pla
ON sch.PlaceCode = pla.PlaceCode
GROUP BY pla.PlaceName, can.OverallSuccess

GO
SELECT * FROM SCHOOL1.SuccessByPlaces ;

DROP VIEW IF EXISTS SCHOOL1.SuccessByPlaces  ;
GO

DROP SCHEMA IF EXISTS SCHOOL1;
GO

# 6. Football League System
## Queries
A)
USE basic_recap_ivana;
GO

SELECT p.BIRTH_DATE, mp.MINUTES_PLAYED AS PLAY_TIME, m.DATE AS MATCH_DATE, mp.ROUND_NUM
FROM PLAYER p
JOIN MATCH_PLAYER mp
ON p.PLAYERID = mp.PLAYERID
JOIN MATCH m
ON mp.ROUND_NUM = m.ROUND_NUM AND mp.PAIR_NUM = m.PAIR_NUM
JOIN FOOTBALL_TEAM ft
ON p.TEAMID = ft.TEAMID
WHERE ft.NAME = 'PARTIZAN'
AND mp.ROUND_NUM = 4
OR
ft.NAME = 'Real Madrid'
AND mp.ROUND_NUM != 7
B)
USE basic_recap_ivana;

WITH FOOTBALL_RANKING AS (
SELECT m.ROUND_NUM, p.NAME_SURNAME, ft.NAME,
COUNT(ms.EVENT) AS GOAL_COUNT,
RANK() OVER (PARTITION BY m.ROUND_NUM ORDER BY COUNT(ms.EVENT) DESC) AS RANK
FROM MATCH m
JOIN MATCH_STATS ms
ON m.PAIR_NUM = ms.PAIR_NUM AND m.ROUND_NUM = ms.ROUND_NUM
JOIN PLAYER p
ON ms.PLAYERID = p.PLAYERID
JOIN FOOTBALL_TEAM ft
ON p.TEAMID = ft.TEAMID
JOIN MATCH_PLAYER mp
ON m.PAIR_NUM = mp.PLAYERID AND m.ROUND_NUM = mp.ROUND_NUM
WHERE ms.EVENT = 'GOAL'
GROUP BY m.ROUND_NUM, p.NAME_SURNAME, ft.NAME
)
SELECT ROUND_NUM, NAME_SURNAME, NAME, GOAL_COUNT, RANK
FROM FOOTBALL_RANKING
;


C)
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS FOOTBALL.LEAGUE_TABLE;
GO

DROP SCHEMA IF EXISTS FOOTBALL;
GO

CREATE SCHEMA FOOTBALL;
GO

CREATE VIEW FOOTBALL.LEAGUE_TABLE
AS
WITH SCORE AS (
SELECT
    ft.NAME AS TEAM_NAME,
    SUM(CASE WHEN ms.EVENT = 'GOAL' AND p.TEAMID = m.HOME_TEAM THEN 1 ELSE 0 END) AS GOALS_SCORED_HOME,
    SUM(CASE WHEN ms.EVENT = 'GOAL' AND p.TEAMID = m.AWAY_TEAM THEN 1 ELSE 0 END) AS GOALS_SCORED_AWAY,
    SUM(CASE WHEN ms.EVENT = 'GOAL' AND p.TEAMID = m.HOME_TEAM THEN 0
             WHEN ms.EVENT = 'GOAL' AND p.TEAMID = m.AWAY_TEAM THEN 1
             ELSE 0 END) AS GOALS_CONCERNED,
    Count(DISTINCT m.ROUND_NUM) AS MATCHES_PLAYED
FROM MATCH m
JOIN MATCH_STATS ms
ON m.PAIR_NUM = ms.PAIR_NUM AND m.ROUND_NUM = ms.ROUND_NUM
JOIN PLAYER p
ON ms.PLAYERID = p.PLAYERID
JOIN FOOTBALL_TEAM ft
ON p.TEAMID = ft.TEAMID
GROUP BY ft.NAME
)
SELECT TEAM_NAME,
    CASE
        WHEN GOALS_SCORED_HOME > GOALS_SCORED_AWAY THEN 3
        WHEN GOALS_SCORED_HOME = GOALS_SCORED_AWAY THEN 1
        ELSE 0
    END AS TOTAL_POINTS,
GOALS_SCORED_HOME AS SCORED_GOALS,
GOALS_SCORED_AWAY AS CONCEDED_GOALS,
ABS(GOALS_SCORED_HOME - GOALS_SCORED_AWAY) AS GOAL_DIFFERENCE,
MATCHES_PLAYED
FROM SCORE
GROUP BY TEAM_NAME, GOALS_SCORED_HOME, GOALS_SCORED_AWAY, ABS(GOALS_SCORED_HOME - GOALS_SCORED_AWAY), MATCHES_PLAYED
;

GO
SELECT * FROM FOOTBALL.LEAGUE_TABLE ;

DROP VIEW IF EXISTS FOOTBALL.LEAGUE_TABLE  ;
GO

DROP SCHEMA IF EXISTS FOOTBALL;
GO

# 7. Public Transportation System
## Queries
a)
USE basic_recap_ivana;

SELECT d.VehicleCode, v.VehicleType, d.DateTime
FROM DEPARTURE d
JOIN VEHICLE v
ON d.VehicleCode = v.VehicleCode
WHERE d.Status = 'Cancelled'
AND d.RouteNumber = 18
AND DATEPART(hour, d.DateTime) BETWEEN 13 AND 17
AND DATEPART(day, d.DateTime) BETWEEN 1 AND 7
AND DATEPART(month, d.DateTime) = 4
AND DATEPART(year, d.DateTime) = 2003
;
b)
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS TRANSPORT.DAILY_DEPARTURE_SCHEDULE;
GO

DROP SCHEMA IF EXISTS TRANSPORT;
GO

CREATE SCHEMA TRANSPORT;
GO

CREATE VIEW TRANSPORT.DAILY_DEPARTURE_SCHEDULE
AS
SELECT rt.RouteNumber, ve.VehicleType, start_st.StationName AS START_STATION_NAME, end_st.StationName AS END_STATION_NAME
FROM DEPARTURE de
JOIN VEHICLE ve
ON de.VehicleCode = ve.VehicleCode
JOIN ROUTE_TRANSPORT rt
ON de.RouteNumber = rt.RouteNumber
JOIN STATION start_st
ON rt.StartStation = start_st.StationCode
JOIN STATION end_st
ON rt.EndStation = end_st.StationCode
;

GO
SELECT * FROM TRANSPORT.DAILY_DEPARTURE_SCHEDULE ;

DROP VIEW IF EXISTS TRANSPORT.DAILY_DEPARTURE_SCHEDULE  ;
GO

DROP SCHEMA IF EXISTS TRANSPORT;
GO




c)
USE basic_recap_ivana;

SELECT
    rt.RouteNumber,
    rt.StartStation,
    rt.EndStation,
    rs.StationCode,
    rs.SEQ_NUM,
    st.StationName,
    start_st.StationName AS StartStationName,
    end_st.StationName AS EndStationName,
    de.DateTime,
    COUNT(de.Status) AS DepartureCount
FROM DEPARTURE de
JOIN VEHICLE ve
  ON de.VehicleCode = ve.VehicleCode
JOIN ROUTE_TRANSPORT rt
  ON de.RouteNumber = rt.RouteNumber
JOIN ROUTE_STATIONS rs
  ON rt.RouteNumber = rs.RouteNumber
JOIN STATION st
  ON rs.StationCode = st.StationCode
JOIN STATION start_st
  ON rt.StartStation = start_st.StationCode
JOIN STATION end_st
  ON rt.EndStation = end_st.StationCode
WHERE YEAR(de.DateTime) = YEAR(GETDATE())
  AND MONTH(de.DateTime) = 1
GROUP BY
    rt.RouteNumber, rt.StartStation, rt.EndStation,
    rs.StationCode, rs.SEQ_NUM,
    st.StationName,
    start_st.StationName,
    end_st.StationName,
    de.DateTime
ORDER BY DAY(de.DateTime) DESC;

d)
USE basic_recap_ivana;

SELECT DATEPART(Quarter, de.DateTime) AS QUARTERS, ve.VehicleType, Count(de.Status) AS PLANNED_DEPARTURES_COUNT,
SUM(CASE WHEN de.Status = 'Successful' THEN 1 ELSE 0 END) AS SuccessfulDepartures,
SUM(CASE WHEN de.Status = 'Cancelled' THEN 1 ELSE 0 END) AS CancelledDepartures,
SUM(CASE WHEN de.Status = 'Delayed' THEN 1 ELSE 0 END) AS DelayedDepartures
FROM DEPARTURE de
JOIN VEHICLE ve
ON de.VehicleCode = ve.VehicleCode
WHERE Year(de.DateTime) = 2002
GROUP BY DATEPART(Quarter, de.DateTime), ve.VehicleType

# 8. Component Management System
## Queries
a)
USE basic_recap_ivana;

SELECT ct.NAME, ta.NAME,ca.VALUE, ass.NAME
FROM COMPONENT co
JOIN COMPONENT_TYPE ct
ON co.COMPONENTTYPE = ct.TYPEID
JOIN TYPE_ATTRIBUTES ta
ON ta.TYPEID = ct.TYPEID
JOIN COMPONENT_ATTRIBUTES ca
ON co.COMPID = ca.COMPID
JOIN ASSEMBLY ass
ON co.COMPID = ass.COMPONENTID
WHERE ct.NAME = 'AAA'
;
b)
SELECT
    AVG(CAST(ca.VALUE AS DECIMAL(18,2))) AS AVERAGE_VALUE,
    MIN(CAST(ca.VALUE AS DECIMAL(18,2))) AS MIN_VALUE,
    MAX(CAST(ca.VALUE AS DECIMAL(18,2))) AS MAX_VALUE
FROM COMPONENT co
JOIN COMPONENT_TYPE ct
  ON co.COMPONENTTYPE = ct.TYPEID
JOIN TYPE_ATTRIBUTES ta
  ON ta.TYPEID = ct.TYPEID
JOIN COMPONENT_ATTRIBUTES ca
  ON co.COMPID = ca.COMPID
 AND ca.ATTRIBUTEID = ta.ATTRIBUTEID
JOIN ASSEMBLY ass
  ON co.COMPID = ass.COMPONENTID
WHERE ta.DOMAIN = 'INTEGER';



c)
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS COMPONENTS.INCORRECT_ATTRIBUTES;
GO

DROP SCHEMA IF EXISTS COMPONENTS;
GO

CREATE SCHEMA COMPONENTS;
GO

CREATE VIEW COMPONENTS.INCORRECT_ATTRIBUTES AS
SELECT
    co.COMPID,
    ca.ATTRIBUTEID,
    NULL AS ATTRIBUTE_NAME,
    'N/A' AS ERROR
FROM COMPONENT co
JOIN COMPONENT_ATTRIBUTES ca
    ON co.COMPID = ca.COMPID
LEFT JOIN TYPE_ATTRIBUTES ta
    ON ta.TYPEID = co.COMPONENTTYPE
   AND ta.ATTRIBUTEID = ca.ATTRIBUTEID
WHERE ta.ATTRIBUTEID IS NULL

UNION ALL

SELECT
    co.COMPID,
    ta.ATTRIBUTEID,
    ta.NAME AS ATTRIBUTE_NAME,
    'REQUIRED' AS ERROR
FROM COMPONENT co
JOIN COMPONENT_TYPE ct
    ON co.COMPONENTTYPE = ct.TYPEID
JOIN TYPE_ATTRIBUTES ta
    ON ta.TYPEID = ct.TYPEID
   AND ta.REQUIRED = 1
LEFT JOIN COMPONENT_ATTRIBUTES ca
    ON ca.COMPID = co.COMPID
   AND ca.ATTRIBUTEID = ta.ATTRIBUTEID
WHERE ca.ATTRIBUTEID IS NULL;
GO
SELECT * FROM COMPONENTS.INCORRECT_ATTRIBUTES;
d)
USE basic_recap_ivana;
GO

INSERT INTO ASSEMBLY (COMPONENTID, NAME)
SELECT c.COMPID, 'primary'
FROM COMPONENT c
WHERE NOT EXISTS (
    SELECT 1
    FROM ASSEMBLY ass
    WHERE ass.COMPONENTID = c.COMPID
);
# 9. Library System
## Queries
a)
USE basic_recap_ivana;
GO

SELECT a.NAME, COUNT(w.[BOOK-ID]) AS BOOK_COUNT
FROM BOOK b
JOIN WROTE w
ON b.[BOOK-ID] = w.[BOOK-ID]
JOIN AUTHOR a
ON w.[AUTHOR-ID] = a.[AUTHOR-ID]
GROUP BY a.NAME
ORDER BY COUNT(w.[BOOK-ID]) DESC
b)
USE basic_recap_ivana;
GO

SELECT bo.TITLE, COUNT(DISTINCT wr.[AUTHOR-ID]) AS AUTHOR_COUNT,
COUNT(DISTINCT bc.[INVENTORY-NUMBER]) COPIES_COUNT
FROM BOOK bo
JOIN WROTE wr
ON bo.[BOOK-ID] = wr.[BOOK-ID]
JOIN AUTHOR au
ON wr.[AUTHOR-ID] = au.[AUTHOR-ID]
JOIN BOOK_COPY bc
ON bo.[BOOK-ID] = bc.[BOOK-ID]
GROUP BY bo.TITLE
HAVING COUNT(DISTINCT wr.[AUTHOR-ID]) % 2 = 1;

c)
USE basic_recap_ivana;
GO

DROP VIEW IF EXISTS BOOK.AUTHOR_COPIES_COUNT;
GO

DROP SCHEMA IF EXISTS BOOK;
GO

CREATE SCHEMA BOOK;
GO

CREATE VIEW BOOK.AUTHOR_COPIES_COUNT AS
SELECT bo.TITLE AS BOOK_TITLE,
COUNT(DISTINCT wr.[AUTHOR-ID]) AS ACTUAL_AUTHOR_COUNT,
bo.NUM_AUTHORS AS AUTHOR_COUNT,
COUNT(DISTINCT bc.[INVENTORY-NUMBER]) ACTUAL_COPIES_COUNT,
bo.NUM_COPIES AS COPIES_COUNT
FROM BOOK bo
JOIN WROTE wr
ON bo.[BOOK-ID] = wr.[BOOK-ID]
JOIN AUTHOR au
ON wr.[AUTHOR-ID] = au.[AUTHOR-ID]
JOIN BOOK_COPY bc
ON bo.[BOOK-ID] = bc.[BOOK-ID]
GROUP BY bo.TITLE, bo.NUM_AUTHORS, bo.NUM_COPIES
HAVING COUNT(DISTINCT wr.[AUTHOR-ID]) % 2 = 1
GO

SELECT BOOK_TITLE, ACTUAL_AUTHOR_COUNT,
AUTHOR_COUNT, ACTUAL_COPIES_COUNT, COPIES_COUNT,
	CASE
		WHEN ACTUAL_AUTHOR_COUNT = AUTHOR_COUNT THEN 'Correct number of authors'
		ELSE 'Incorrect number of authors'
	END AS AUTHRO_COUNT_STATUS,

	CASE
		WHEN ACTUAL_COPIES_COUNT = COPIES_COUNT THEN 'Correct number of copies'
		ELSE 'Incorrect number of copies'
	END AS COPIES_COUNT_STATUS
FROM BOOK.AUTHOR_COPIES_COUNT;

DROP VIEW IF EXISTS BOOK.AUTHOR_COPIES_COUNT;
GO

DROP SCHEMA IF EXISTS BOOK;
GO

# 10. Hotel Management System
## Queries
a)
USE basic_recap_ivana;

SELECT ho.NAME, rt.NAME, hr.TOTAL_ROOMS, hr.PRICE
FROM HOTEL ho
JOIN HOTEL_ROOMTYPE hr
ON ho.HOTELID = hr.HOTELID
JOIN ROOMTYPE rt
ON hr.ROOMTYPEID = rt.ROOMTYPEID
JOIN RESERVATION_HOTEL rh
ON ho.HOTELID = rh.HOTELID
JOIN ROOM ro
ON ro.HOTELID = ho.HOTELID
AND ro.ROOMNUMBER = rh.ROOMNUMBER
WHERE ho.CLASS = '3-star'
AND hr.TOTAL_ROOMS >= 2
ORDER BY rt.NAME DESC,
hr.PRICE ASC
;
    b)
USE basic_recap_ivana;

DROP VIEW IF EXISTS HOTELS.NUMBERS_BY_CITIES;
GO

DROP SCHEMA IF EXISTS HOTELS;
GO

CREATE SCHEMA HOTELS;
GO

CREATE VIEW HOTELS.NUMBERS_BY_CITIES
AS
SELECT ho.CITY AS CITY_NAME,
ho.CLASS AS HOTEL_CLASS,
hr.TOTAL_ROOMS AS TOTAL_NUMBER_OF_ROOMS,
COUNT(ho.HOTELID) AS TOTAL_NUMBER_OF_HOTELS
FROM HOTEL ho
JOIN HOTEL_ROOMTYPE hr
ON ho.HOTELID = hr.HOTELID
GROUP BY ho.CITY, ho.CLASS, hr.TOTAL_ROOMS
;
GO

SELECT * FROM HOTELS.NUMBERS_BY_CITIES;

DROP VIEW IF EXISTS HOTELS.NUMBERS_BY_CITIES;
GO

DROP SCHEMA IF EXISTS HOTELS;
GO

c)
USE basic_recap_ivana;

UPDATE HRT
SET HRT.TOTAL_ROOMS = RC.ACTUAL_ROOM_COUNT
FROM HOTEL_ROOMTYPE HRT
JOIN (
    SELECT R.HOTELID, R.ROOMTYPE AS ROOMTYPEID,
           COUNT(*) AS ACTUAL_ROOM_COUNT
    FROM ROOM R
    GROUP BY R.HOTELID, R.ROOMTYPE
) RC
  ON HRT.HOTELID   = RC.HOTELID
 AND HRT.ROOMTYPEID = RC.ROOMTYPEID;

# 11. Supply Chain System
d) Write a program in C (exceptionally in pseudo code) that sets the STATUS attribute value to "HIGH" for suppliers who had more than 100 deliveries in the first quarter of the current year. (Note: The relational system supports only single-table queries.)

## Queries
a)
USE basic_recap_ivana;

SELECT cu.CNAME, de.QUANTITY
FROM DELIVERY de
JOIN SUPPLIER su
ON de.SUP = su.SUP
JOIN PRODUCT pr
ON de.PRD = pr.PRD
JOIN CUSTOMER cu
ON de.CUS = cu.CUS
WHERE pr.COLOR = 'yellow'
AND Year(de.DATE) = '2000'
b)
USE basic_recap_ivana;

DROP VIEW IF EXISTS DELIVERY.EXCHANGE;
GO

DROP SCHEMA IF EXISTS DELIVERY;
GO

CREATE SCHEMA DELIVERY;
GO

CREATE VIEW DELIVERY.EXCHANGE AS
SELECT su.SNAME, su.CITY AS S_CITY, cu.CNAME, cu.CITY AS C_CITY
FROM DELIVERY de
JOIN SUPPLIER su
ON de.SUP = su.SUP
JOIN CUSTOMER cu
ON de.CUS = cu.CUS
WHERE su.CITY != cu.CITY
AND year(de.DATE) = year(GETDATE())
;
GO

SELECT *
FROM DELIVERY.EXCHANGE;
GO

DROP VIEW IF EXISTS DELIVERY.EXCHANGE;
GO

DROP SCHEMA IF EXISTS DELIVERY;
GO

c)


d)
